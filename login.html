<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irathiens | Iniciar Sesión</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #ff9a1f;
            --border: rgba(0, 242, 255, 0.3);
            --glass: rgba(13, 22, 31, 0.85);
            --danger-led: #ff0000;
            --hologram: rgba(0, 242, 255, 0.1);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; font-family: 'Rajdhani', sans-serif;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        .btn-close-terminal {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 45px;
            height: 45px;
            border: 2px solid var(--primary);
            background: rgba(0,0,0,0.8);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-family: 'Orbitron';
            font-size: 1.4rem;
            z-index: 1000;
            transition: 0.3s;
            clip-path: polygon(20% 0%, 100% 0, 100% 80%, 80% 100%, 0 100%, 0% 20%);
        }

        .btn-close-terminal:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 20px var(--primary);
            transform: scale(1.1);
        }

        .login-box, .register-box {
            position: relative; background: var(--glass); padding: 40px;
            border: 1px solid var(--border); width: 100%; max-width: 400px;
            text-align: center; backdrop-filter: blur(10px);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.15);
            clip-path: polygon(0 0, 100% 0, 100% 88%, 88% 100%, 0 100%);
            z-index: 10; transition: all 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045);
        }

        .hidden { display: none; opacity: 0; transform: scale(0.8); }

        .logo {
            font-family: 'Orbitron', sans-serif; color: var(--primary);
            font-size: 1.6rem; margin-bottom: 30px; letter-spacing: 4px;
            text-shadow: 0 0 15px var(--primary);
        }

        .input-group { margin-bottom: 25px; text-align: left; }
        label {
            display: block; font-size: 0.75rem; color: var(--primary);
            margin-bottom: 8px; text-transform: uppercase; font-weight: bold;
        }

        input {
            width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border); color: white;
            font-family: 'Rajdhani'; font-size: 1rem; outline: none;
        }

        .btn-login {
            width: 100%; padding: 15px; background: var(--primary);
            color: #000; border: none; font-family: 'Orbitron';
            font-weight: bold; cursor: pointer; transition: 0.4s;
        }

        .switch-mode {
            margin-top: 20px; color: var(--border); font-size: 0.8rem;
            cursor: pointer; text-transform: uppercase;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="btn-close-terminal" onclick="window.location.href='index'" title="ABORTAR_CONEXIÓN">✕</div>

    <canvas id="starfield"></canvas>

    <div class="login-box" id="loginBox">
        <div class="logo">IRATHIENS_LOGIN</div>
        <form id="loginForm">
            <div class="input-group">
                <label>Email de Usuario</label>
                <input type="email" id="username" required placeholder="correo@ejemplo.com">
            </div>
            <div class="input-group">
                <label>Contraseña</label>
                <input type="password" id="password" required placeholder="••••••••">
            </div>
            <button type="submit" class="btn-login">Acceder al Sistema</button>
            <p id="error" style="color:red; display:none; margin-top:10px;">ACCESO DENEGADO</p>
        </form>
        <div class="switch-mode" onclick="toggleForm()">¿No tienes cuenta? Registrar Ciudadano</div>
    </div>

    <div class="register-box hidden" id="registerBox">
        <div class="logo" style="color: #00f2ff;">NUEVO_REGISTRO</div>
        <form id="registerForm">
            <div class="input-group">
                <label style="color: #00f2ff;">Email de Alistamiento</label>
                <input type="email" id="regEmail" required style="border-color: #00f2ff;">
            </div>
            <div class="input-group">
                <label style="color: #00f2ff;">Establecer Contraseña</label>
                <input type="password" id="regPassword" required style="border-color: #00f2ff;">
            </div>
            <button type="submit" class="btn-login" style="background: #00f2ff;">Confirmar Alistamiento</button>
        </form>
        <div class="switch-mode" onclick="toggleForm()">Volver al Terminal de Acceso</div>
    </div>

    <script>
        const SB_URL = 'https://dfizvgagofsctgwzksgd.supabase.co'; 
        const SB_KEY = 'sb_publishable_3iByg_zBXp4C-SCtfeIiDw_NeyfB3wR';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        function toggleForm() {
            document.getElementById('loginBox').classList.toggle('hidden');
            document.getElementById('registerBox').classList.toggle('hidden');
        }

        // LÓGICA DE LOGIN ARREGLADA
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const { data, error } = await _supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                const errBox = document.getElementById('error');
                errBox.style.display = 'block';
                errBox.innerText = "ERROR: " + error.message;
            } else {
                window.location.href = "perfil";
            }
        });

        // LÓGICA DE REGISTRO ARREGLADA (ESTO ERA LO QUE NO TENÍAS)
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            const { data, error } = await _supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    emailRedirectTo: window.location.origin
                }
            });

            if (error) {
                alert("ERROR EN REGISTRO: " + error.message);
            } else {
                alert("¡REGISTRO COMPLETADO! Revisa tu email para confirmar o intenta entrar si la confirmación está desactivada.");
                toggleForm();
            }
        });

        // MOTOR DE ESTRELLAS (SIN TOCAR)
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let stars = Array(500).fill().map(() => ({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 2,
            speed: Math.random() * 3
        }));

        function drawStars() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            stars.forEach(s => {
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill();
                s.y += s.speed; if (s.y > canvas.height) s.y = 0;
            });
            requestAnimationFrame(drawStars);
        }
        drawStars();

        (function() {
            let path = window.location.pathname;
            if (path.endsWith('.html')) {
                window.history.replaceState(null, '', path.replace('.html', ''));
            }
        })();
    </script>
</body>
</html>
