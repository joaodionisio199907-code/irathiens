<script>
    // --- CONFIGURACIÓN ---
    const SB_URL = 'https://dfizvgagofsctgwzksgd.supabase.co';
    const SB_KEY = 'sb_publishable_3iByg_zBXp4C-SCtfeIiDw_NeyfB3wR';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-links a').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
    }

    // 1. SESIÓN Y GENERACIÓN AUTOMÁTICA DE TOKEN
    async function checkUserSession() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) {
            document.getElementById('bio-token').innerText = "INICIA_SESIÓN_PRIMERO";
            return;
        }

        const user = session.user;
        const tokenBox = document.getElementById('bio-token');

        // Intentamos obtener el perfil
        let { data: profile } = await _supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        // Si no existe o no tiene token, lo creamos/actualizamos
        if (!profile || !profile.bio_token) {
            const generatedToken = "BIO-" + Math.random().toString(36).substring(2, 10).toUpperCase();
            const { data: newProfile, error: upsertError } = await _supabase
                .from('profiles')
                .upsert({ id: user.id, bio_token: generatedToken, karma_points: 0, is_verified: false })
                .select().single();
            
            if (upsertError) {
                tokenBox.innerText = "ERROR_PERMISOS_SQL";
                return;
            }
            profile = newProfile;
        }

        // Mostrar datos en pantalla
        if (profile) {
            tokenBox.innerText = profile.bio_token;
            document.getElementById('profile-handle').innerText = profile.rsi_handle || "CADETE_SIN_ID";
            document.getElementById('karma-val').innerText = profile.karma_points || 0;
            if (profile.is_verified) {
                const tag = document.getElementById('status-tag');
                tag.innerText = "ESTADO: VERIFICADO";
                tag.style.color = "var(--success)";
            }
        }
    }

    // 2. VERIFICACIÓN CON LIMPIEZA DE URL
    async function verificarConRSI() {
        let handle = document.getElementById('rsi-handle-input').value.trim();
        const msg = document.getElementById('msg-overlay');
        
        if (!handle) return alert("Ingresa tu Handle RSI o URL");

        // SI EL USUARIO PEGA LA URL, EXTRAEMOS EL NOMBRE:
        if (handle.includes("citizens/")) {
            handle = handle.split("citizens/")[1].split("/")[0].split("?")[0];
        }

        const { data: { user } } = await _supabase.auth.getUser();
        if (!user) return alert("Sesión expirada");

        msg.style.color = 'var(--accent)';
        msg.innerText = "> SINCRONIZANDO CON RSI...";

        const { error } = await _supabase
            .from('profiles')
            .update({ rsi_handle: handle, is_verified: true })
            .eq('id', user.id);

        if (error) {
            msg.innerHTML = `<span style="color:var(--danger)">> ERROR: ${error.message}</span>`;
        } else {
            msg.innerHTML = `<span style="color:var(--success)">> SINC_EXITOSA: PILOTO ${handle}</span>`;
            setTimeout(() => location.reload(), 1500);
        }
    }

    // 3. AUTO-SCAN CATÁLOGO
    async function buscarEnCatalogo(query) {
        const suggestionsDiv = document.getElementById('suggestions');
        if (query.length < 2) { suggestionsDiv.style.display = 'none'; return; }
        const { data } = await _supabase.from('item_catalog').select('name, manufacturer').ilike('name', `%${query}%`).limit(5);
        if (data && data.length > 0) {
            suggestionsDiv.innerHTML = '';
            suggestionsDiv.style.display = 'block';
            data.forEach(item => {
                const d = document.createElement('div');
                d.className = 'suggestion-item';
                d.innerHTML = `<span style="color:var(--primary)">[${item.manufacturer}]</span> ${item.name}`;
                d.onclick = () => { document.getElementById('item-name').value = item.name; suggestionsDiv.style.display = 'none'; };
                suggestionsDiv.appendChild(d);
            });
        } else { suggestionsDiv.style.display = 'none'; }
    }

    // 4. CARGAR MERCADO
    async function loadMarketItems() {
        const grid = document.getElementById('market-items');
        const { data: items } = await _supabase.from('marketplace_items').select('*, profiles:seller_id(rsi_handle, is_verified)').eq('status', 'available').order('created_at', { ascending: false });
        if (!items) return;
        grid.innerHTML = '';
        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `<div class="item-img" style="background-image: url('https://via.placeholder.com/400x200/060b14/ff9a1f?text=${item.item_name}');"></div><div style="padding: 15px;"><div style="display:flex; justify-content:space-between;"><span>${item.category.toUpperCase()}</span>${item.profiles?.is_verified ? '<span class="verified-badge">VERIFICADO</span>' : ''}</div><h3 style="font-size:1rem;">${item.item_name}</h3><div style="color:var(--accent)">${item.price_auec.toLocaleString()} aUEC</div><div style="font-size:0.7rem; color:var(--muted)">Vendedor: ${item.profiles?.rsi_handle || 'Anon'}</div><button class="btn-primary" style="margin-top:10px;">COMPRAR</button></div>`;
            grid.appendChild(card);
        });
    }

    // 5. PUBLICAR
    async function publicarItem() {
        const { data: { user } } = await _supabase.auth.getUser();
        const name = document.getElementById('item-name').value;
        const price = document.getElementById('item-price').value;
        const cat = document.getElementById('item-cat').value;
        if(!name || !price) return alert("Faltan datos.");
        const { error } = await _supabase.from('marketplace_items').insert([{ seller_id: user.id, item_name: name, price_auec: parseInt(price), status: 'available', category: cat }]);
        if (!error) location.reload();
    }

    function copyToken() {
        const t = document.getElementById('bio-token').innerText;
        if(t.includes("BIO-")) { navigator.clipboard.writeText(t); alert("TOKEN COPIADO: Pégalo en tu perfil de RSI"); }
    }

    window.onload = () => {
        checkUserSession();
        loadMarketItems();
    };
</script>
